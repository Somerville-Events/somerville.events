name: CI/CD

on:
  push:
    branches:
      - main
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  test:
    name: Build & Test
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:17
        env:
          POSTGRES_HOST_AUTH_METHOD: trust
          POSTGRES_USER: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Cache dependencies
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-machete
        run: cargo install cargo-machete

      - name: Install sqlx-cli
        run: cargo install sqlx-cli --no-default-features --features postgres

      - name: Setup Database
        env:
          DB_SUPERUSER: postgres
          DB_SUPERDB: postgres
          PGHOST: localhost
          DB_NAME: test
          DB_APP_USER_PASS: test
          DB_MIGRATOR_PASS: ${{ secrets.DB_MIGRATOR_PASS }}
          PSQL_BIN: psql
          DATABASE_URL: postgresql://migrator:${{ secrets.DB_MIGRATOR_PASS }}@localhost/test
        run: |
          ./reset_database.sh
          sqlx migrate run

      - name: Check Formatting
        run: cargo fmt -- --check

      - name: Check Unused Dependencies
        run: cargo machete --with-metadata

      - name: Lint with Clippy
        env:
          DATABASE_URL: postgresql://migrator:${{ secrets.DB_MIGRATOR_PASS }}@localhost/test
        run: cargo clippy --all-targets -- -D warnings

      - name: Run Tests
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GOOGLE_MAPS_API_KEY: ${{ secrets.GOOGLE_MAPS_API_KEY }}
          BASIC_AUTH_USER: test
          BASIC_AUTH_PASS: test
          DB_APP_USER_PASS: test
          DB_NAME: test
          PUBLIC_URL: "http://localhost:8080"
          DATABASE_URL: postgresql://migrator:${{ secrets.DB_MIGRATOR_PASS }}@localhost/test
        run: cargo test

      - name: Build Release
        env:
          DATABASE_URL: postgresql://migrator:${{ secrets.DB_MIGRATOR_PASS }}@localhost/test
        if: github.ref == 'refs/heads/main'
        run: cargo build --release

      - name: Prepare Artifacts
        if: github.ref == 'refs/heads/main'
        run: |
          mkdir -p dist
          cp target/release/somerville-events dist/
          cp target/release/ingest_events dist/
          cp -r static dist/
          cp -r migrations dist/
          cp deploy.sh dist/
          
      - name: Upload Artifact
        if: github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: app-bundle
          path: dist/

  deploy:
    name: Deploy
    needs: test
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: app-bundle
          path: dist

      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          known_hosts: ${{ secrets.KNOWN_HOSTS }}
          if_key_exists: replace

      - name: Deploy to VPS
        env:
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
        run: |
          SHA=${{ github.sha }}
          REMOTE_DIR="~/artifacts/${SHA}"
          ssh ${VPS_USER}@${VPS_HOST} "mkdir -p ${REMOTE_DIR}"
          scp -p -r dist/* ${VPS_USER}@${VPS_HOST}:${REMOTE_DIR}/
          ssh ${VPS_USER}@${VPS_HOST} "chmod +x ${REMOTE_DIR}/deploy.sh ${REMOTE_DIR}/somerville-events ${REMOTE_DIR}/ingest_events"
          ssh ${VPS_USER}@${VPS_HOST} "DB_MIGRATOR_PASS='${{ secrets.DB_MIGRATOR_PASS }}' bash ${REMOTE_DIR}/deploy.sh ${SHA}"
