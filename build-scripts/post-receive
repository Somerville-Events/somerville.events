#!/usr/bin/env bash
set -Eeuo pipefail

read -r OLD NEW REF
# Only build on pushes to main
if [ "$REF" != "refs/heads/main" ]; then
  exit 0
fi

# Ensure any prior build unit is not running and clear failed state
systemctl --user stop -q build.service || true
systemctl --user reset-failed build.service || true

# Run the build as a transient unit
systemd-run \
  --user \
  --unit=build \
  --description="Build ${NEW} for somerville-events" \
  --property=KillMode=control-group \
  --property=Type=exec \
  --collect \
  --same-dir \
  --no-block \
  /bin/bash -lc "/home/git/build.sh ${NEW}"