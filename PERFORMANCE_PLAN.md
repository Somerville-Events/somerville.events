# Performance CI Integration Plan

I will add a GitHub Actions workflow to run the performance test suite on every Pull Request. The workflow will execute the runner, capture the output, and post a comment on the PR comparing the current results with historical data.

## 1. CI Workflow (`.github/workflows/perf.yml`)

- **Trigger**: `pull_request` (and `push` to main to update history).
- **Steps**:
- Checkout code.
- Setup Rust (cache cargo).
- Setup Postgres (service container).
- Run `cargo run --bin perf_runner`.
- **Reporting**:
    - If strictly failing (regressions), the job fails.
    - If successful (or warning), it uses `actions/github-script` or a dedicated action to read `perf_report.md` (generated by runner) and post/update a comment on the PR.

## 2. Runner Enhancements (`src/bin/perf_runner.rs`)

- **Report Generation**: Add logic to generate a Markdown summary (`perf_report.md`) suitable for PR comments.
- Table of metrics (Current vs Baseline vs Limit).
- Trend indicators (e.g., üü¢, üî¥, ‚ö†Ô∏è).
- **History Handling in CI**:
- The runner typically needs read/write access to `perf_history.json`.
- **Strategy**: On PRs, we can't easily write back to the repo history safely (security restriction on forks, plus merge conflicts).
- **Proposed Solution**:
    - **PRs**: Read `perf_history.json` (from main branch via checkout or artifact) to compare. Do *not* commit new history.
    - **Main Branch**: Run tests and *commit* the new `perf_history.json` back to the repo (or upload as artifact/store in external storage if repo bloat is a concern, but JSON is small enough for now).
    - For this iteration, I'll stick to **repo-committed history** on the main branch. The PR workflow will fetch the `main` branch version of `perf_history.json` for comparison.

## 3. GitHub Action Permissions

- Needs `pull-requests: write` to post comments.
- Needs `contents: write` (on main branch runs) to update history.

## Files

- [`.github/workflows/perf.yml`](.github/workflows/perf.yml): New workflow.
- [`src/bin/perf_runner.rs`](src/bin/perf_runner.rs): Updates to support Markdown report generation and "read-only/compare" mode.

## Todos
- [ ] Create src/mock_middleware.rs implementing awc middleware for interception
- [ ] Update src/main.rs to use the middleware when MOCK_SERVICES is set
- [ ] Create perf_config.json
- [ ] Create src/bin/perf_runner.rs with payload metrics, stats, and Markdown report generation
- [ ] Create .github/workflows/perf.yml for CI integration
- [ ] Run perf_runner baseline locally to verify

