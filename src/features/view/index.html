{% extends "common/index.html" %}

{% block css %}
{% include "common/simple_event_body.css" %}
{% include "view/index.css" %}
{% endblock %}

{% block content %}
<header>
    <h1>Somerville Events</h1>
    <div class="search-form" role="search">
        <input type="search" form="filter-form" name="q" value="{{ query.q.as_deref().unwrap_or_default() }}"
            placeholder="Search">
        <button type="submit" form="filter-form" aria-label="Search">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="icon-search">
                <circle cx="11" cy="11" r="8"></circle>
                <path d="m21 21-4.3-4.3"></path>
            </svg>
        </button>
    </div>
    <a href="/upload" class="button primary">Upload an event flyer</a>
</header>

<div class="layout">
    <aside>
        <details {% if query.has_filters() %}open{% endif %}>
            <summary>Filter Events</summary>
            <form id="filter-form" action="/" method="GET">
                <div class="filters-body">
                    {% if is_past_view %}
                    <input type="hidden" name="past" value="true">
                    {% endif %}

                    <label class="filter-list-item">
                        <input type="checkbox" name="free" value="true" {% if query.free.unwrap_or(false) %}checked{%
                            endif %}>
                        Free events only
                    </label>

                    <div class="filter-group">
                        <label class="filter-date-label">
                            Day
                            <input type="date" name="on" {% if let Some(d)=query.on %}value="{{d}}" {% endif %}>
                        </label>
                    </div>

                    <details class="filter-group" {% if !query.event_types.is_empty() %}open{% endif %}>
                        <summary>Event Type</summary>
                        <fieldset class="chips">
                            {% for t in all_event_types %}
                            <label style="--chip-color: {{ t.color|safe }}">
                                <input type="checkbox" name="type" value="{{ t.value }}" {% if
                                    query.has_event_type(t.value.as_str()) %}checked{% endif %}>
                                <svg class="icon">
                                    <use href="#{{ t.icon }}"></use>
                                </svg>
                                {{ t.label }}
                            </label>
                            {% endfor %}
                        </fieldset>
                    </details>

                    <details class="filter-group" {% if !query.source.is_empty() %}open{% endif %}>
                        <summary>Source</summary>
                        <fieldset>
                            {% for s in all_sources %}
                            {% if query.has_source(s.value.as_str()) %}
                            <label class="filter-list-item">
                                <input type="checkbox" name="source" value="{{ s.value }}" checked>
                                {{ s.label }}
                            </label>
                            {% endif %}
                            {% endfor %}

                            {% for s in all_sources %}
                            {% if !query.has_source(s.value.as_str()) %}
                            <label class="filter-list-item">
                                <input type="checkbox" name="source" value="{{ s.value }}">
                                {{ s.label }}
                            </label>
                            {% endif %}
                            {% endfor %}
                        </fieldset>
                    </details>

                    <details class="filter-group" {% if !query.location.is_empty() %}open{% endif %}>
                        <summary>Location</summary>
                        <fieldset>
                            {% for l in all_locations %}
                            {% if query.has_location(l.value.as_str()) %}
                            <label class="filter-list-item">
                                <input type="checkbox" name="location" value="{{ l.value }}" checked>
                                {{ l.label }}
                            </label>
                            {% endif %}
                            {% endfor %}

                            {% for l in all_locations %}
                            {% if !query.has_location(l.value.as_str()) %}
                            <label class="filter-list-item">
                                <input type="checkbox" name="location" value="{{ l.value }}">
                                {{ l.label }}
                            </label>
                            {% endif %}
                            {% endfor %}
                        </fieldset>
                    </details>

                    <details class="filter-group">
                        <summary>Subscribe to Calendar</summary>
                        <div class="filters-body">
                            <p class="help-text no-margin-top">
                                Get these events on your phone or computer. Updates automatically.
                            </p>

                            <div class="actions vertical">
                                <a href="{{ webcal_url }}" class="button secondary">
                                    <svg class="icon">
                                        <use href="#icon-calendar"></use>
                                    </svg>
                                    Apple
                                </a>

                                <a href="{{ google_cal_link }}" class="button secondary" target="_blank"
                                    rel="noopener noreferrer">
                                    <svg class="icon">
                                        <use href="#icon-calendar"></use>
                                    </svg>
                                    Google
                                </a>
                            </div>

                            <label class="filter-date-label margin-top">
                                Or copy this URL:
                                <input type="text" readonly value="{{ https_url }}" onclick="this.select()">
                            </label>
                            <p class="help-text">
                                Paste it into <a href="https://calendar.google.com/calendar/u/0/r/settings/addbyurl"
                                    target="_blank">Google Calendar Settings</a> or your calendar app.
                            </p>
                        </div>
                    </details>
                </div>

                <div class="actions">
                    <button type="submit">Apply Filters</button>
                    <a href="/{% if is_past_view %}?past=true{% endif %}" class="button secondary">Clear</a>
                </div>
            </form>
        </details>
    </aside>

    <main>
        {% if is_past_view %}
        <p><a class="button" href="/">Show upcoming events</a></p>
        {% endif %}

        <div class="days-container">
            {% for day in days %}
            <section class="events-day" aria-labelledby="{{ day.day_id }}">
                <h2 id="{{ day.day_id }}">{{ day.date_header }}</h2>
                {% for event in day.events %}
                {% include "common/simple_event_body.html" %}
                {% endfor %}
            </section>
            {% endfor %}
        </div>

        <footer>
            {% if let Some(prev) = prev_day_link %}
            <div class="pagination">
                <a href="{{ prev }}" class="button secondary">Previous Day</a>
                {% if let Some(next) = next_day_link %}
                <a href="{{ next }}" class="button secondary">Next Day</a>
                {% endif %}
            </div>
            {% else %}
            {% if !is_past_view %}
            <a href="/?past=true" class="button secondary">View past events</a>
            {% endif %}
            {% endif %}
        </footer>
    </main>
</div>
{% endblock %}